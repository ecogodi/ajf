<ng-container *ngIf="formGroup|async as currentFormGroup">
  <form novalidate [formGroup]="currentFormGroup">
    <div class="ajf-form-container">
      <ion-toolbar *ngIf="showTopToolbar" [class.ajf-hidden]="!sliderReady">
        {{ title | translate }}
        <ion-buttons right>
            <ion-button default (click)="onSave($event)"
                *ngIf="permissions && permissions.write">{{ 'Save' | translate }}</ion-button>
            <ion-button default (click)="onFormAction($event, 'send')"
                [disabled]="((errors | async) || 0) != 0"
                *ngIf="permissions && permissions.change_state && permissions.change_state.send">{{ 'Submit' | translate }}</ion-button>
            <ion-button default (click)="onFormAction($event, 'approve')"
                [disabled]="((errors | async) || 0) != 0"
                *ngIf="permissions && permissions.change_state && permissions.change_state.approve">{{ 'Approve' | translate }}</ion-button>
            <ion-button default (click)="onFormAction($event, 'deprecate')"
                [disabled]="((errors | async) || 0) != 0"
                *ngIf="permissions && permissions.change_state && permissions.change_state.deprecate"> {{ 'Deprecate' | translate }}</ion-button>
            </ion-buttons>
      </ion-toolbar>
      <div class="ajf-slider-container">
        <ajf-page-slider [showNavigationButtons]="showNavigationButtons"
            (pageScrollFinish)="bubblePageScrollFinish($event)"
            (ready)="sliderReady = true" #formSlider>
          <div ajf-page-slider-body>
            <ng-container *ngIf="(slides|async) as curSlides">
              <ng-container *ngIf="curSlides.length > 0 && hasStartMessage">
                <ajf-page-slider-item>
                  <ajf-page-slider-item-header>
                    <h2>
                      <span class="number">
                        1  &rarr;
                      </span>
                      <span class="ajf-title">
                        <ng-content select="ajf-form-start-message-title"></ng-content>
                      </span>
                    </h2>
                  </ajf-page-slider-item-header>
                  <ng-content select="ajf-form-start-message"></ng-content>
                </ajf-page-slider-item>
              </ng-container>
              <ng-container *ngFor="let slideInstance of curSlides; trackBy: trackNodeById">
                <ng-container *ngIf="(!isRepeatingSlide(slideInstance)) && slideInstance.visible">
                  <ajf-page-slider-item>
                    <ajf-page-slider-item-header>
                      <ion-icon color="danger" name="ajf-warning" *ngIf="!slideInstance.valid"></ion-icon>
                      <ion-icon color="secondary" name="checkmark" *ngIf="slideInstance.valid"></ion-icon>
                      <h2>
                        <span class="number">{{ slideInstance.position + (hasStartMessage | boolToInt) }} &rarr;</span>
                        <span class="ajf-title">{{ slideInstance.slide.label | translate}}</span>
                      </h2>
                    </ajf-page-slider-item-header>
                    <ng-container *ngFor="let fieldInstance of slideInstance.flatNodes; trackBy: trackNodeById">
                      <div [ngClass]="'ajf-' + fieldInstance.field.size" class="ajf-field-entry"
                          *ngIf="fieldInstance.visible">
                        <i [class]="fieldInstance.field | fieldIcon" item-right></i>
                        <p>{{ fieldInstance.field.description }}</p>
                        <ion-label [innerHTML]="fieldInstance.field.label | translate"></ion-label>
                        <ajf-field [fieldInstance]="fieldInstance"></ajf-field>
                      </div>
                    </ng-container>
                  </ajf-page-slider-item>
                </ng-container>
                <ng-container *ngIf="isRepeatingSlide(slideInstance) && slideInstance.visible">
                  <ajf-page-slider-item *ngFor="let curRep of slideInstance.repsArr; let idx = index; let lastSlide = last">
                    <ajf-page-slider-item-header>
                      <ion-icon color="danger" name="ajf-warning" *ngIf="!slideInstance.validSlide(idx)"></ion-icon>
                      <ion-icon color="secondary" name="checkmark" *ngIf="slideInstance.validSlide(idx)"></ion-icon>
                      <h2>
                        <span class="number">{{ slideInstance.slidePosition(idx) }} &rarr;</span>
                        <span class="ajf-title">{{ slideInstance.slide.label | translate }}</span>
                      </h2>
                    </ajf-page-slider-item-header>
                    <div *ngIf="lastSlide" class="ajf-group-actions">
                      <button ion-fab mini (click)="addGroup(slideInstance)" [disabled]="!slideInstance.canAddGroup" mat-mini-fab>
                        <ion-icon name="add"></ion-icon>
                      </button>
                      <button ion-fab mini (click)="removeGroup(slideInstance)" [disabled]="!slideInstance.canRemoveGroup" mat-mini-fab>
                        <ion-icon name="remove"></ion-icon>
                      </button>
                    </div>
                    <ng-container *ngFor="let fieldInstance of slideInstance.slideNodes[idx]; trackBy: trackNodeById">
                      <div [ngClass]="'ajf-' + fieldInstance.field.size" class="ajf-field-entry"
                          *ngIf="fieldInstance.visible">
                        <i [class]="fieldInstance.field | fieldIcon" item-right></i>
                        <p>{{ fieldInstance.field.description }}</p>
                        <ion-label [innerHTML]="fieldInstance.field.label | translate"></ion-label>
                        <ajf-field [fieldInstance]="fieldInstance"></ajf-field>
                      </div>
                    </ng-container>
                  </ajf-page-slider-item>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="curSlides.length > 0 && hasEndMessage">
                <ajf-page-slider-item>
                  <ajf-page-slider-item-header>
                    <h2>
                      <span *ngIf="(slidesNum|async) as snum" class="number">
                        {{ snum + (hasStartMessage | boolToInt) + 1 }} &rarr;
                      </span>
                      <span class="ajf-title">
                        <ng-content select="ajf-form-end-message-title"></ng-content>
                      </span>
                    </h2>
                  </ajf-page-slider-item-header>
                  <ng-content select="ajf-form-end-message"></ng-content>
                </ajf-page-slider-item>
              </ng-container>
            </ng-container>
          </div>
          <div ajfPageSliderBar *ngIf="showBottomToolbar">
            <div class="ajf-left-bar">
              <ion-buttons class="ajf-errors" *ngIf="((errors | async) || 0) > 0">
                <ion-button (click)="goToPrevError()" color="danger">
                  <ion-icon
                      name="arrow-up"></ion-icon>
                </ion-button>
                <ion-button (click)="goToNextError()" color="danger">
                  <ion-icon
                      name="arrow-down"></ion-icon>
                </ion-button>
              </ion-buttons>
              <div class="ajf-info-box ajf-error">
                <div class="ajf-title" translate>
                  Errors
                </div>
                <div class="ajf-content">
                  {{ errors | async }} / {{ slidesNum|async }}
                </div>
              </div>
            </div>
          </div>
        </ajf-page-slider>
      </div>
    </div>
  </form>
</ng-container>
